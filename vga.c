/*
 * vga.c - VGA Graphics Driver for GegOS
 * Mode 12h: 640x480, 16 colors, planar
 */

#include "vga.h"
#include "io.h"

/* VGA framebuffer address */
static uint8_t* const VGA_MEMORY = (uint8_t*)0xA0000;

/* VGA registers */
#define VGA_MISC_WRITE      0x3C2
#define VGA_SEQ_INDEX       0x3C4
#define VGA_SEQ_DATA        0x3C5
#define VGA_CRTC_INDEX      0x3D4
#define VGA_CRTC_DATA       0x3D5
#define VGA_GC_INDEX        0x3CE
#define VGA_GC_DATA         0x3CF
#define VGA_AC_INDEX        0x3C0
#define VGA_AC_WRITE        0x3C0
#define VGA_INSTAT_READ     0x3DA

/* Graphics controller registers */
#define GC_GRAPHICS_MODE    0x05
#define GC_BIT_MASK         0x08
#define GC_READ_MAP_SELECT  0x04

/* Sequencer registers */
#define SEQ_MAP_MASK        0x02

/* Mode 12h register values (640x480, 16 color) */
static const uint8_t mode12h_misc = 0xE3;

static const uint8_t mode12h_seq[] = {
    0x03, 0x01, 0x0F, 0x00, 0x06
};

static const uint8_t mode12h_crtc[] = {
    0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0x0B, 0x3E,
    0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xEA, 0x0C, 0xDF, 0x28, 0x00, 0xE7, 0x04, 0xE3,
    0xFF
};

static const uint8_t mode12h_gc[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0F,
    0xFF
};

static const uint8_t mode12h_ac[] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
    0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
    0x01, 0x00, 0x0F, 0x00, 0x00
};

/* Simple 8x8 bitmap font */
static const uint8_t font8x8[128][8] = {
    [0 ... 31] = {0,0,0,0,0,0,0,0},
    [' '] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['!'] = {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00},
    ['"'] = {0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00},
    ['#'] = {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00},
    ['$'] = {0x18,0x7E,0xC0,0x7C,0x06,0xFC,0x18,0x00},
    ['%'] = {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00},
    ['&'] = {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00},
    [39]  = {0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00},
    ['('] = {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00},
    [')'] = {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00},
    ['*'] = {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    ['+'] = {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    [','] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30},
    ['-'] = {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    ['.'] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    ['/'] = {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00},
    ['0'] = {0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x00},
    ['1'] = {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00},
    ['2'] = {0x7C,0xC6,0x06,0x1C,0x30,0x66,0xFE,0x00},
    ['3'] = {0x7C,0xC6,0x06,0x3C,0x06,0xC6,0x7C,0x00},
    ['4'] = {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00},
    ['5'] = {0xFE,0xC0,0xC0,0xFC,0x06,0xC6,0x7C,0x00},
    ['6'] = {0x38,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00},
    ['7'] = {0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00},
    ['8'] = {0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00},
    ['9'] = {0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00},
    [':'] = {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00},
    [';'] = {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30},
    ['<'] = {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    ['='] = {0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00},
    ['>'] = {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00},
    ['?'] = {0x7C,0xC6,0x0C,0x18,0x18,0x00,0x18,0x00},
    ['@'] = {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00},
    ['A'] = {0x38,0x6C,0xC6,0xFE,0xC6,0xC6,0xC6,0x00},
    ['B'] = {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00},
    ['C'] = {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00},
    ['D'] = {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00},
    ['E'] = {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00},
    ['F'] = {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00},
    ['G'] = {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3A,0x00},
    ['H'] = {0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00},
    ['I'] = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    ['J'] = {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00},
    ['K'] = {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00},
    ['L'] = {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00},
    ['M'] = {0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00},
    ['N'] = {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00},
    ['O'] = {0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00},
    ['P'] = {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    ['Q'] = {0x7C,0xC6,0xC6,0xC6,0xC6,0xCE,0x7C,0x0E},
    ['R'] = {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00},
    ['S'] = {0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00},
    ['T'] = {0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00},
    ['U'] = {0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00},
    ['V'] = {0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00},
    ['W'] = {0xC6,0xC6,0xC6,0xD6,0xD6,0xFE,0x6C,0x00},
    ['X'] = {0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00},
    ['Y'] = {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00},
    ['Z'] = {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00},
    ['['] = {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00},
    [92]  = {0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00},
    [']'] = {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00},
    ['^'] = {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    ['_'] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    ['`'] = {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00},
    ['a'] = {0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00},
    ['b'] = {0xE0,0x60,0x7C,0x66,0x66,0x66,0xDC,0x00},
    ['c'] = {0x00,0x00,0x7C,0xC6,0xC0,0xC6,0x7C,0x00},
    ['d'] = {0x1C,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00},
    ['e'] = {0x00,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00},
    ['f'] = {0x3C,0x66,0x60,0xF8,0x60,0x60,0xF0,0x00},
    ['g'] = {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8},
    ['h'] = {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00},
    ['i'] = {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00},
    ['j'] = {0x06,0x00,0x06,0x06,0x06,0x66,0x66,0x3C},
    ['k'] = {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00},
    ['l'] = {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    ['m'] = {0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0x00},
    ['n'] = {0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00},
    ['o'] = {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0x00},
    ['p'] = {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0},
    ['q'] = {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E},
    ['r'] = {0x00,0x00,0xDC,0x76,0x60,0x60,0xF0,0x00},
    ['s'] = {0x00,0x00,0x7E,0xC0,0x7C,0x06,0xFC,0x00},
    ['t'] = {0x30,0x30,0xFC,0x30,0x30,0x36,0x1C,0x00},
    ['u'] = {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00},
    ['v'] = {0x00,0x00,0xC6,0xC6,0xC6,0x6C,0x38,0x00},
    ['w'] = {0x00,0x00,0xC6,0xD6,0xD6,0xFE,0x6C,0x00},
    ['x'] = {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00},
    ['y'] = {0x00,0x00,0xC6,0xC6,0xC6,0x7E,0x06,0xFC},
    ['z'] = {0x00,0x00,0x7E,0x4C,0x18,0x32,0x7E,0x00},
    ['{'] = {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00},
    ['|'] = {0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    ['}'] = {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00},
    ['~'] = {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00},
    [127] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
};

/* Bytes per line in planar mode */
#define BYTES_PER_LINE 80

/* Set read plane */
static void set_read_plane(uint8_t plane) {
    outb(VGA_GC_INDEX, GC_READ_MAP_SELECT);
    outb(VGA_GC_DATA, plane);
}
/* Set write mode (0 or 2) */
static inline void set_write_mode(int mode) {
    outb(VGA_GC_INDEX, GC_GRAPHICS_MODE);
    outb(VGA_GC_DATA, mode);
}

/* Fast plane mask - all planes */
static inline void set_all_planes(void) {
    outb(VGA_SEQ_INDEX, SEQ_MAP_MASK);
    outb(VGA_SEQ_DATA, 0x0F);
}
/* Initialize VGA Mode 12h (640x480, 16 colors) */
void vga_init(void) {
    int i;
    
    /* Write miscellaneous register */
    outb(VGA_MISC_WRITE, mode12h_misc);
    
    /* Write sequencer registers */
    for (i = 0; i < 5; i++) {
        outb(VGA_SEQ_INDEX, i);
        outb(VGA_SEQ_DATA, mode12h_seq[i]);
    }
    
    /* Unlock CRTC registers */
    outb(VGA_CRTC_INDEX, 0x03);
    outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) | 0x80);
    outb(VGA_CRTC_INDEX, 0x11);
    outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) & ~0x80);
    
    /* Write CRTC registers */
    for (i = 0; i < 25; i++) {
        outb(VGA_CRTC_INDEX, i);
        outb(VGA_CRTC_DATA, mode12h_crtc[i]);
    }
    
    /* Write graphics controller registers */
    for (i = 0; i < 9; i++) {
        outb(VGA_GC_INDEX, i);
        outb(VGA_GC_DATA, mode12h_gc[i]);
    }
    
    /* Write attribute controller registers */
    inb(VGA_INSTAT_READ);  /* Reset flip-flop */
    for (i = 0; i < 21; i++) {
        outb(VGA_AC_INDEX, i);
        outb(VGA_AC_WRITE, mode12h_ac[i]);
    }
    
    /* Enable display */
    inb(VGA_INSTAT_READ);
    outb(VGA_AC_INDEX, 0x20);
    
    /* Clear screen */
    vga_clear(COLOR_BLACK);
}

/* Clear screen - write to all planes */
void vga_clear(uint8_t color) {
    for (int plane = 0; plane < 4; plane++) {
        outb(VGA_SEQ_INDEX, SEQ_MAP_MASK);
        outb(VGA_SEQ_DATA, 1 << plane);
        uint8_t plane_val = (color & (1 << plane)) ? 0xFF : 0x00;
        
        uint8_t* vga = VGA_MEMORY;
        for (int i = 0; i < BYTES_PER_LINE * SCREEN_HEIGHT; i++) {
            vga[i] = plane_val;
        }
    }
    outb(VGA_SEQ_INDEX, SEQ_MAP_MASK);
    outb(VGA_SEQ_DATA, 0x0F);
}

/* Draw pixel using write mode 2 */
void vga_putpixel(int x, int y, uint8_t color) {
    if (x < 0 || x >= SCREEN_WIDTH || y < 0 || y >= SCREEN_HEIGHT) return;
    
    int offset = y * BYTES_PER_LINE + x / 8;
    uint8_t mask = 0x80 >> (x & 7);
    
    outb(VGA_GC_INDEX, GC_GRAPHICS_MODE);
    outb(VGA_GC_DATA, 0x02);
    
    outb(VGA_GC_INDEX, GC_BIT_MASK);
    outb(VGA_GC_DATA, mask);
    
    volatile uint8_t dummy = VGA_MEMORY[offset];
    (void)dummy;
    VGA_MEMORY[offset] = color;
    
    outb(VGA_GC_INDEX, GC_GRAPHICS_MODE);
    outb(VGA_GC_DATA, 0x00);
    outb(VGA_GC_INDEX, GC_BIT_MASK);
    outb(VGA_GC_DATA, 0xFF);
}

/* Get pixel */
uint8_t vga_getpixel(int x, int y) {
    if (x < 0 || x >= SCREEN_WIDTH || y < 0 || y >= SCREEN_HEIGHT) return 0;
    
    int offset = y * BYTES_PER_LINE + x / 8;
    uint8_t mask = 0x80 >> (x & 7);
    uint8_t color = 0;
    volatile uint8_t byte_val;
    
    for (int plane = 0; plane < 4; plane++) {
        set_read_plane(plane);
        byte_val = VGA_MEMORY[offset];  /* Read after setting plane */
        if (byte_val & mask) {
            color |= (1 << plane);
        }
    }
    return color;
}

/* Horizontal line */
void vga_hline(int x, int y, int width, uint8_t color) {
    for (int i = 0; i < width; i++) {
        vga_putpixel(x + i, y, color);
    }
}

/* Vertical line */
void vga_vline(int x, int y, int height, uint8_t color) {
    for (int i = 0; i < height; i++) {
        vga_putpixel(x, y + i, color);
    }
}

/* Line (Bresenham) */
void vga_line(int x1, int y1, int x2, int y2, uint8_t color) {
    int dx = x2 - x1;
    int dy = y2 - y1;
    int sx = (dx > 0) ? 1 : -1;
    int sy = (dy > 0) ? 1 : -1;
    if (dx < 0) dx = -dx;
    if (dy < 0) dy = -dy;
    int err = dx - dy;
    
    while (1) {
        vga_putpixel(x1, y1, color);
        if (x1 == x2 && y1 == y2) break;
        int e2 = 2 * err;
        if (e2 > -dy) { err -= dy; x1 += sx; }
        if (e2 < dx) { err += dx; y1 += sy; }
    }
}

/* Rectangle outline */
void vga_rect(int x, int y, int width, int height, uint8_t color) {
    vga_hline(x, y, width, color);
    vga_hline(x, y + height - 1, width, color);
    vga_vline(x, y, height, color);
    vga_vline(x + width - 1, y, height, color);
}

/* Filled rectangle */
void vga_fillrect(int x, int y, int width, int height, uint8_t color) {
    for (int j = 0; j < height; j++) {
        for (int i = 0; i < width; i++) {
            vga_putpixel(x + i, y + j, color);
        }
    }
}

/* Circle outline */
void vga_circle(int cx, int cy, int radius, uint8_t color) {
    int x = radius, y = 0, err = 0;
    while (x >= y) {
        vga_putpixel(cx + x, cy + y, color);
        vga_putpixel(cx + y, cy + x, color);
        vga_putpixel(cx - y, cy + x, color);
        vga_putpixel(cx - x, cy + y, color);
        vga_putpixel(cx - x, cy - y, color);
        vga_putpixel(cx - y, cy - x, color);
        vga_putpixel(cx + y, cy - x, color);
        vga_putpixel(cx + x, cy - y, color);
        y++;
        if (err <= 0) err += 2 * y + 1;
        if (err > 0) { x--; err -= 2 * x + 1; }
    }
}

/* Filled circle */
void vga_fillcircle(int cx, int cy, int radius, uint8_t color) {
    for (int y = -radius; y <= radius; y++) {
        for (int x = -radius; x <= radius; x++) {
            if (x * x + y * y <= radius * radius) {
                vga_putpixel(cx + x, cy + y, color);
            }
        }
    }
}

/* Draw character */
void vga_putchar(int x, int y, char c, uint8_t fg, uint8_t bg) {
    unsigned char uc = (unsigned char)c;
    if (uc > 127) uc = '?';
    const uint8_t* glyph = font8x8[uc];
    for (int row = 0; row < 8; row++) {
        for (int col = 0; col < 8; col++) {
            uint8_t pixel = (glyph[row] >> (7 - col)) & 1;
            vga_putpixel(x + col, y + row, pixel ? fg : bg);
        }
    }
}

/* Draw string */
void vga_putstring(int x, int y, const char* str, uint8_t fg, uint8_t bg) {
    int startx = x;
    while (*str) {
        if (*str == '\n') { x = startx; y += 8; }
        else { vga_putchar(x, y, *str, fg, bg); x += 8; }
        str++;
    }
}

/* Wait for vsync */
void vga_vsync(void) {
    while (inb(VGA_INSTAT_READ) & 0x08);
    while (!(inb(VGA_INSTAT_READ) & 0x08));
}

/* Swap buffer */
void vga_swap(void) {
    vga_vsync();
}
